on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        default: ''
      approvers:
         required: false
         type: string 
         default: ''
      minimum_approvals:
         required: false
         type: string 
      deny_self_approver:
         required: false
         type: boolean
         default: false
      runner:
        required: false
        type: string
      backend_rg:
        required: true
        type: string
      backend_sa:
        required: true
        type: string
      backend_sa_container:
        required: true
        type: string
      backend_sa_key:
        required: true
        type: string
      tf_actions_working_dir:
        required: true
        type: string
      params_dir:
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  pull-requests: write
  issues: write
  packages: read
env: 
  ARM_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
  ARM_USE_AZUREAD: true
  REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
  SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
  NODE_TLS_REJECT_UNAUTHORIZED: 0
  GIT_SSL_NO_VERIFY: true
  NODE_EXTRA_CA_CERTS: '/etc/ssl/certs/ca-certificates.crt'

jobs:
  terraform-plan:
    name: Terraform Plan
    if: ${{ github.ref == 'refs/heads/main' || inputs.environment == 'dev' }}
    environment: ${{ inputs.environment }}
    runs-on: 
       group: ${{ inputs.runner }}
    env:
      #this is needed since we are running terraform with read-only permissions
      ARM_SKIP_PROVIDER_REGISTRATION: true
    outputs:
      tfplanExitCode: ${{ steps.tf-plan.outputs.exitcode }} 
      tfplanSummary: ${{ steps.tf-plan-string.outputs.summary }} 
    defaults:
      run:
        working-directory: ${{ github.workspace }}/${{ inputs.tf_actions_working_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hp-infrastructure/dlz-github-workflow/setup@v1.0.0

      - name: Set Node.js 20.x for GitHub Action
        uses: hp-infrastructure/dlz-github-workflow/node@v1.0.0

      - name: Terraform Init
        uses: hp-infrastructure/dlz-github-workflow/init@v1.0.0
        with:
          backend_rg: ${{ inputs.backend_rg }}
          backend_sa: ${{ inputs.backend_sa }}
          backend_sa_container: ${{ inputs.backend_sa_container }}
          backend_sa_key: ${{ inputs.backend_sa_key }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}
          github_token: ${{ secrets.DLZ_GITHUB_TOKEN }}

      - name: Terraform Validate
        uses: hp-infrastructure/dlz-github-workflow/validate@v1.0.0
        with:
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}

      - name: Terraform Format
        uses: hp-infrastructure/dlz-github-workflow/format@v1.0.0
        with:
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}

      - name: Terraform Plan
        id: tf-plan
        uses: hp-infrastructure/dlz-github-workflow/plan@v1.0.0
        with:
          environment: ${{ inputs.environment }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}
          params_dir: ${{ inputs.params_dir }}

      - name: Publish Terraform Plan
        uses: hp-infrastructure/dlz-github-workflow/publish@v1.0.0
        with:
          environment: ${{ inputs.environment }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}

      - name: Create String Output
        id: tf-plan-string
        uses: hp-infrastructure/dlz-github-workflow/summary@v1.0.0
        with:
          environment: ${{ inputs.environment }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }} 

  manual-approval:
    name: manual approval
    runs-on: 
       group: ${{ inputs.runner }}
    needs: terraform-plan
    if: ${{ needs.terraform-plan.outputs.tfplanExitCode == 2 }} 
    steps: 
      # Generate a github issue for approval purposes
      - name: Require Approval to apply
        uses: hp-infrastructure/gh-action-manual-approval@main
        with:
          secret: ${{ github.TOKEN }}
          approvers: '${{ inputs.approvers }}'
          minimum-approvals: ${{ inputs.minimum-approvals }}
          issue-title: 'Terraform apply of ${{ github.repository }} to env ${{ inputs.environment }}'
          issue-body: |
            Please approve or deny the deployment of ${{ github.repository }}@${{ inputs.environment }}
          exclude-workflow-initiator-as-approver: ${{ inputs.deny_self_approver }}
        #continue-on-error: true

  terraform-apply:
    name: Terraform Apply
    runs-on: 
       group: ${{ inputs.runner }}
    needs: manual-approval
    if: ${{ needs.terraform-plan.outputs.tfplanExitCode == 2 }} 
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ${{ inputs.tf_actions_working_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hp-infrastructure/dlz-github-workflow/setup@v1.0.0

      - name: Set Node.js 20.x for GitHub Action
        uses: hp-infrastructure/dlz-github-workflow/node@v1.0.0

      - name: Terraform Init
        uses: hp-infrastructure/dlz-github-workflow/init@v1.0.0
        with:
          backend_rg: ${{ inputs.backend_rg }}
          backend_sa: ${{ inputs.backend_sa }}
          backend_sa_container: ${{ inputs.backend_sa_container }}
          backend_sa_key: ${{ inputs.backend_sa_key }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}
          github_token: ${{ secrets.DLZ_GITHUB_TOKEN }}

      - name: Download Terraform Plan
        uses: hp-infrastructure/dlz-github-workflow/download@v1.0.0
        with:
          environment: ${{ inputs.environment }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}

      - name: Terraform Apply
        uses: hp-infrastructure/dlz-github-workflow/apply@v1.0.0
        with:
          environment: ${{ inputs.environment }}
          tf_actions_working_dir: ${{ inputs.tf_actions_working_dir }}    
